# COMPENDIUM EXAMPLE

## Testing on local device

**Required:**

1. postgres or docker

2. postman or similar

3. a working `compendium server`

**Set up configuration:**

- Postgres in local.

    By default: pointing to `localhost:5432` and database `postgres`.
 Configurable on environment var: `COMPENDIUM_METADATA_STORAGE_JDBC_URL` by default: `"jdbc:postgresql://localhost:5432/postgres"

- Docker

  In the root directory of this project you can find a `docker-compose` yaml file and a `Dockerfile` file. On this directory, run

        docker-compose up

- Postman

    Import collection on `src/main/resources/compendium.postman_collection.json`. Please notice this has `localhost:8080` as a default host for compendium server.
    POST calls has to give a **string** with the whole schema. It wil be parsed internally.

    Currently `sbt-compendium` handles avro schema. But `compendium-server` admits `protobuf`, `mu`, `scala`, `avro` and `openapi`.

- sbt plugin

    Add to your `project/plugin.sbt` file the following line

    `addSbtPlugin("io.higherkindness" %% "sbt-compendium" % "0.0.1-SNAPSHOT")`

    Also to your `build.sbt` file add to your project settings

    `.settings(
        compendiumProtocolIdentifiers := List("product","supplier","sale","client"),
        compendiumServerHost := "localhost",
        compendiumServerPort := 8080,
        compendiumFormatSchema:="avro",
        sourceGenerators in Compile += Def.task {
          compendiumGenClients.value
        }.tapendiumServerPort := 8080,
        compendiumFormatSchema:="proto",
        sourceGenerators in Compile += Def.task {
          compendiumGenClients.value
        }.taskValue
    )`

    The configuration works as follow:

    - `compendiumServerHost`: String. Url of the compendium server. Default: "localhost"
    - `compendiumServerPort`: Integer. Port of the compendium server. Default: 47047
    - `compendiumFormatSchema`: String. Schema type to download. Default: "avro". Valid values: "avro", "proto".
    - `compendiumProtocolIdentifiers: `List[String]`. Protocol identifiers to be retrieved from compendium server. Default: Nil


## Model example
To show this example run:

    sbt "project plugin" run

- The log traces will show some data.
- In `target/scala-2.12/src_managed` will appear scala files with all the case classes.
- On `plugin/src/main/resources` there are some csv files with data that correspond to its proper case class.


Let's suppose some data with the following structure:

| name | fields |
| ---- | ------ |
| supplier | id_supplier, name, email, phone |
| sale | client*, product** |
| client* | id_client, name, surname, email |
| product** | id_prod, description, color, size |
| material | name, code, shipId |


In postgres, schemas will be saved as a full string with the POST call:

| name | schema |
| ------- | ---------------------------------------- |
| supplier | "{\"type\":\"record\",\"name\":\"Supplier\",\"namespace\":\"higherkindness.compendiumtest\",\"fields\":[{\"name\":\"id_supplier\",\"type\":\"string\"},{\"name\":\"name\",\"type\":\"string\"},{\"name\":\"email\",\"type\":\"string\"},{\"name\":\"phone\",\"type\":\"string\"}]}" |
| sale | "{\"type\":\"record\",\"name\":\"Sale\",\"namespace\":\"higherkindness.compendiumtest\",\"fields\":[{\"name\":\"client\",\"type\":{\"type\":\"record\",\"name\":\"Client\",\"fields\":[{\"name\":\"id_client\",\"type\":\"string\"},{\"name\":\"name\",\"type\":\"string\"},{\"name\":\"surname\",\"type\":\"string\"},{\"name\":\"email\",\"type\":\"string\"}]}},{\"name\":\"product\",\"type\":{\"type\":\"record\",\"name\":\"Product\",\"fields\":[{\"name\":\"id_prod\",\"type\":\"string\"},{\"name\":\"description\",\"type\":\"string\"},{\"name\":\"color\",\"type\":\"string\"},{\"name\":\"size\",\"type\":\"string\"}]}}]}" |
| client* | Generated by the nested schema in `sale` |
| product** | Generated by the nested schema in `sale` |
| material | "{\"type\":\"record\",\"name\":\"Material\",\"namespace\":\"higherkindness.compendiumtest\",\"fields\":[{\"name\":\"name\",\"type\":\"string\"},{\"name\":\"code\",\"type\":\"string\"},{\"name\":\"shipId\",\"type\":\"string\"}]}" |

Schemas have been flatted using [From json to string Converter](https://tools.knowledgewalls.com/jsontostring)

Please, notice that in POST calls the identifiers need to be added to the `compendiumProtocolIdentifiers` list in the `build.sbt` file.


### Avro files in JSON format

This section provides, in json format, the schemas presented previously. Also it contains new models and versions to test the behaviour of `compendium`.
Remember, compendium always provides the last version saved.

##### Supplier schema:

    {
      "type": "record",
      "name": "Supplier",
      "namespace": "higherkindness.compendiumtest",
      "fields": [
        {
            "name": "id_supplier",
            "type": "string"
        }, 
        {
            "name": "name",
            "type": "string"
        },
        {
            "name": "email",
            "type": "string"
        },
        {
            "name": "phone",
            "type": "string"
        }
      ]
    }

##### Sale schema:

    {
      "type": "record",
      "name": "Sale",
      "namespace": "higherkindness.compendiumtest",
      "fields": [
        {
            "name": "client",
            "type": "higherkindness.compendiumtest.Client"
        },
        {
            "name": "product",
            "type": "higherkindness.compendiumtest.Product"
        }
      ]
    }

##### Client schema [used in nested supplier schema]:

    {
      "type": "record",
      "name": "Client",
      "namespace": "higherkindness.compendiumtest",
      "fields": [
        {
            "name": "id_client",
            "type": "string"
        },  
        {
            "name": "name",
            "type": "string"
        },
        {
            "name": "surname",
            "type": "string"
        },
        {
            "name": "email",
            "type": "string"
        }
      ]
    }


##### Product schema [used in nested Supplier schema]:

    {
      "type": "record",
      "name": "Product",
      "namespace": "higherkindness.compendiumtest",
      "fields": [
        {
            "name": "id_prod",
            "type": "string"
        },
        {
            "name": "description",
            "type": "string"
        },    
        {
            "name": "color",
            "type": "string"
        },
        {
            "name": "size",
            "type": "string"
        }
      ]
    }

##### Material schema (first version):

    {
      "type": "record",
      "name": "Material",
      "namespace": "higherkindness.compendiumtest",
      "fields": [
        {
            "name": "name",
            "type": "string"
        },
        {
            "name": "code",
            "type": "string"
        },
        {
            "name": "shipId",
            "type": "string"
        }
      ]
    }


#### Future iterations

##### Product schema (second version):

    {
      "type": "record",
      "name": "Product",
      "namespace": "higherkindness.compendiumtest",
      "fields": [
         {
            "name": "id_prod",
            "type": "string"
        },
        {
            "name": "name",
            "type": "string"
        },
        {
            "name": "color",
            "type": "string"
        },
        {
            "name": "size",
            "type": "string"
        },
        {
            "name": "soldDate",
            "type": "string"
        }
      ]
    }


##### Material schema (second version):

    {
      "type": "record",
      "name": "Material",
      "namespace": "higherkindness.compendiumtest",
      "fields": [
        {
            "name": "name",
            "type": "string"
        },
        {
            "name": "code",
            "type": "string"
        },
        {
            "name": "originIdentifier",
            "type": "higherkindness.compendiumtest.Supplier"
        },    
        {
            "name": "shipId",
            "type": "string"
        },    
        {
            "name": "color",
            "type": "string"
        }
      ]
    }

##### Process version:

    {
      "type": "record",
      "name": "Process",
      "namespace": "higherkindness.compendiumtest",
      "fields": [
        {
            "name": "name",
            "type": "string"
        },
        {
            "name": "mat",
            "type": {
                "type": "array",
                "items": "higherkindness.compendiumtest.Material"
            }
        },
        {
            "name": "prod",
            "type": "higherkindness.compendiumtest.Product"
        }
      ]
    }

